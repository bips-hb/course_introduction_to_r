{
  "hash": "db1a01f014dcb3e28d25eab574061a0d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"5: ggplot2\"\nformat: \n  html:\n    toc: true\neditor: visual\n---\n\n\n\n\nBuilding on the previous section, this is where things get visual!\n\nFinally!\n\nWe'll start by loading the tidyverse and gapminder for the data:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.4     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(gapminder)\n```\n:::\n\n\n\n\n\n## Introducing: `ggplot2`\n\nAs far as data visualization goes, `ggplot2` is probably the most popular package in the R ecosystem.\\\nIt's an implementation of the \"Grammar of graphics\", hence the `gg`, and it's well known for its versatility.\nWe can create the most common types of plots with relative ease, including\n\n-   Scatterplots\n-   Boxplots\n-   Histograms\n-   Barcharts (horizontal or vertical)\n\nA ggplot is made up of **layers**, which are added to the plot with `+` and can be modified with `+` as well.\\\nThink of building a ggplot as stacking layers on top of each other, and modifying the layers as you go.\n\nLet's start with an example of a scatterplot:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(gapminder)\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\n\nThis doesn't really do anything yet -- it's the *empty* layer.\nBut at least we specific a dataset.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(gapminder, mapping = aes(x = lifeExp, y = gdpPercap))\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n\nHere we used `aes()` to declare a *mapping* or *aesthetics* between the variables `lifeExp` to the x-axis and `gdpPercap` to the y-axis.\nThis is the crucial step to creating a plot!\nBut we have not decided what the *geometric* object is going to be, which is the `geom_` part of the plot.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(gapminder, aes(x = lifeExp, y = gdpPercap)) +\n  geom_point()\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\nThis already looks like a scatterplot!\\\nWe might want to adjust the point size, color, etc. -- that's the job of the `geom`!\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(gapminder, aes(x = lifeExp, y = gdpPercap)) +\n  geom_point(size = 5, color = \"#206b0d\", alpha = 0.1)\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\nWe can save the plot to a variable `p` and then modify it afterwards:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- ggplot(gapminder, aes(x = lifeExp, y = gdpPercap)) +\n  geom_point(size = 3, color = \"blue\", alpha = 0.25)\n\np\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\nFor example, we can try out some themes, for examples those provided by the `ggthemes` package:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggthemes)\n\np + theme_calc()\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n```{.r .cell-code}\np + theme_economist()\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-7-2.png){width=672}\n:::\n\n```{.r .cell-code}\np + theme_base()\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-7-3.png){width=672}\n:::\n\n```{.r .cell-code}\np + theme_excel()\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-7-4.png){width=672}\n:::\n\n```{.r .cell-code}\np + theme_excel_new()\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-7-5.png){width=672}\n:::\n\n```{.r .cell-code}\np + theme_stata()\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-7-6.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Default theme, but with bigger text\np + theme_gray(base_size = 14)\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Lukas' \"go to\" theme :)\np + theme_minimal(base_size = 14)\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-8-2.png){width=672}\n:::\n:::\n\n\n\n\nPlaying around with ggplot themes is usually a great way to spend an afternoon, so we'll leave it at that for now, but you can find more info at the [ggthemes](https://yutannihilation.github.io/allYourFigureAreBelongToUs/ggthemes/) website or ggplot2's documentation at https://ggplot2.tidyverse.org.\n\n### Core `geom_`s\n\nFor now we will keep the colors and theming simple and focus on the most common types of plots you'll likely want to create:\n\n-   Scatterplots -\\> `geom_point()`\n-   Boxplots -\\> `geom_boxplot()`\n-   Histograms -\\> `geom_histogram()`\n-   Barcharts (horizontal or vertical) -\\> `geom_col()` or `geom_bar()`\n\nAs a general tip, it's often useful to use tidyverse verbs as \"pre-processing\" before piping data into `ggplot()`, that way you can focus on the plot itself after you have prepared your data to look like you need it for the type of plot you want.\n\n#### Scatterplots\n\nWe have seen an example scatterplot before, but given the data at hand it's probably more useful to focus on a specific year at a time, which is easiest to do with a `filter()` step beforehand\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- gapminder |>\n  filter(year == 1987) |>\n  ggplot(aes(x = lifeExp, y = gdpPercap)) +\n  geom_point()\n```\n:::\n\n\n\n\n::: callout-note\nIf you get confused between using `|>` and `+`, know that you are not alone!\\\nLuckily, the error messages are informative.\n:::\n\nA more advanced examples would be to add a linear regression line, but in this case we can already see that a linear fit is not appropriate here.\nWe can still add a regression line though, by adding new layer:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np +\n  geom_smooth()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using method = 'loess' and formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n\n`geom_smooth()` will add a general trendline, which could be a linear model or a loess curve or a GAM -- if you want to explicitly add a linear trendline, use `geom_smooth(method = \"lm\")`, but beware that this is not always approriate!\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np +\n  geom_smooth(method = \"lm\", color = \"red\", se = FALSE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n\nIn some cases, a scatterplot is maybe not well suited, for example if the `x`-variable is *technically* numeric but *effectively* categorical, like `year` in this case:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |>\n  ggplot(aes(x = year, y = gdpPercap)) +\n  geom_point()\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n\n\nThat's where boxplots are useful!\n\n#### Boxplots\n\nSo a boxplot where each year gets its own box should be straight forward, yes?\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |>\n  ggplot(aes(x = year, y = gdpPercap)) +\n  geom_boxplot()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Continuous x aesthetic\nℹ did you forget `aes(group = ...)`?\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n\nUnfortunately, no.\nSince `year` is technically numeric, we have two ways to deal with it and let ggplot now that `year` should be used as a grouping variable, and one of which the error message already suggested:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |>\n  ggplot(aes(x = year, y = gdpPercap, group = year)) +\n  geom_boxplot()\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n\n```{.r .cell-code}\ngapminder |>\n  ggplot(aes(x = year, y = gdpPercap, group = year)) +\n  geom_boxplot() +\n  scale_y_log10()\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-14-2.png){width=672}\n:::\n:::\n\n\n\n\nHere `group` is used within `aes()` as a special mapping that tells `ggplot` that `year` should be used to group the data into boxplots without us needing to otherwise modify the data.\n\nHowever, if we wanted, we could also recode `year` to be a factor variable just for this one case, which should alos get us where we need:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |>\n  mutate(year = as.factor(year)) |>\n  ggplot(aes(x = year, y = gdpPercap)) +\n  geom_boxplot()\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |>\n  filter(year == 1997) |>\n  ggplot(aes(x = continent, y = pop)) +\n  geom_boxplot(fill = \"darkred\", alpha = .25) +\n  scale_y_log10(labels = scales::number_format()) +\n  theme_minimal(base_size = 14) +\n  theme(\n    axis.title = element_text(hjust = 0, size = unit(13, \"mm\"))\n  )\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n\n\n#### Histograms\n\nA histogram is technically a type of barchart, but since it's so common and requires binning the data, it get's a special place within ggplot.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- gapminder |>\n  filter(year == 2007) |>\n  ggplot(aes(x = lifeExp))\n  \np +\n  geom_histogram(color = \"black\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n\n\nIf the defaults are not suited well, we can adjust the bins with `binwidth` (in this case the number of years on the x-axis) or `bins` to specify the number of bins in total.\nAnother thing we'll add is the `color` argument, which for a barchart changes the outline color of the bars and let's us see the bars better.\nThere's also `fill`, which changes the fill color of the bars.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np + geom_histogram(binwidth = 5, color = \"black\") \n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n\n```{.r .cell-code}\np + geom_histogram(binwidth = 10, color = \"black\")\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-18-2.png){width=672}\n:::\n\n```{.r .cell-code}\np + geom_histogram(bins = 10, color = \"black\")\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-18-3.png){width=672}\n:::\n:::\n\n\n\n\n#### Barcharts\n\nSometimes people use different names vor horizontal or vertical bar charts, and confusingly enough ggplot only differentiates between \"column\" charts and \"bar\" charts, both of which can have either orientation.\n\nLet's settle on a simple goal: the number of observations (countries) per continent in 2007.\\\nFor practice, let's first calculate that using `dplyr` verbs and use the `n()` helper function which just counts the number of rows (in a group):\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |>\n  filter(year == 2007) |>\n  group_by(continent) |>\n  summarize(n = n())\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 2\n  continent     n\n  <fct>     <int>\n1 Africa       52\n2 Americas     25\n3 Asia         33\n4 Europe       30\n5 Oceania       2\n```\n\n\n:::\n:::\n\n\n\n\nThis combination of `group_by() |> summarize(n = n())` is so common that ggplot has a shortcut for it: `count()`:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |>\n  filter(year == 2007) |>\n  count(continent)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 2\n  continent     n\n  <fct>     <int>\n1 Africa       52\n2 Americas     25\n3 Asia         33\n4 Europe       30\n5 Oceania       2\n```\n\n\n:::\n:::\n\n\n\n\nBut we digress -- let's get charting:\n\n`geom_bar()` behaves similar to `geim_histogram()`, but for categorical variables.\nIt doesn't do any binning, and just counts the number of observations for each group defined by the variable passed to `x`:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- gapminder |>\n  filter(year == 2007) |>\n  ggplot(aes(x = continent)) +\n  geom_bar()\n\np\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n\n\nIf we want to change orientation, it's easy to do, but there are multiple ways!\n\nVersion 1: Use `coord_flip()`:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np + coord_flip()\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\n\n\nVersion 2: Pass the variable to `y` rather than `x`:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |>\n  filter(year == 2007) |>\n  ggplot(aes(y = continent)) +\n  geom_bar()\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n\n\n\n::: callout-note\nThe reason there are multiple ways to do that is because early on, only version 1 was possible, and version 2 was only made possible relatively recently.\\\nThere are many things like that in ggplot2, so please don't be afraid to try out different ways of doing things --- unless you get a warning or error message, it's probably fine if it gets you what you want, and when in doubt there's always good onlie documentation or tutorials.\n:::\n\nBut what about `geom_col`?\\\nWell, sometimes we just want to make a barchart without ggplot doing the counting for us!\\\nMaybe we want percentages rather than absolute numbers on the `y`-axis for example.\nThat's what `geom_col()` is for: It let's us define `x` *and* `y` variables.\n\nLet's say we want the same basic plot as before, but with percentages:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |>\n  filter(year == 2007) |>\n  group_by(continent) |>\n  summarize(\n    n = n(),\n    percent = n / n_distinct(gapminder$country)\n  ) |>\n  ggplot(aes(x = continent, y = percent)) +\n  geom_col()\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n\n\n\nNote that we need to refer to the full dataset to get the total number of countries here in order to calculate the percentages, because after we have used `group_by()`, all operations are limited to the group we are currently working with!\n\nSo as far as the plot goes, this is technically correct, but not very nice to look at.\\\nLet's use this as a starting point to make our plots a little nicer!\n\n### Your turn: Customization\n\nIf we wanted to use this plot in a publication or presentation, we probably should make a few tweaks.\n\nLet's specify a few \"wants\", together with a few hints on how to achieve them, and experiment with them!\n\n1.  Change the axis labels to something more human-readable\n2.  Add a title, subtitle, and caption to better describe what we're seeing\n3.  Maybe a nicer `fill` color than gray? Pick one you like from <https://www.color-hex.com/>\n4.  Reorder the columns from highest to lowest\n\nAdvanced:\n\n5.  The y-axis labels would probably look better as \"30%\" rather than \"0.3\"\n\nHints:\n\n-   Look at the documentation at <https://ggplot2.tidyverse.org/reference/index.html>\n-   `labs()` should suffice for 1 and 2!\n-   The function `color()` lists all color names R knows, otherwise you can use RGB codes like `#CBDFBD` if you google \"RGB color picker\" you'll find a lot of examples!\n-   Reordering the continents is as easy as using `reorder()`!\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |>\n  filter(year == 2007) |>\n  group_by(continent) |>\n  summarize(\n    n = n(),\n    percent = n / n_distinct(gapminder$country)\n  ) |>\n  ggplot(aes(x = reorder(continent, desc(percent)), y = percent)) +\n  geom_col(fill = \"#63AEE1\") +\n  scale_y_continuous(\n    breaks = seq(0, 1, by = 0.1),\n    labels = scales::label_percent()\n  ) +\n  labs(\n    title = \"Countries per Continent\",\n    subtitle = \"Data from Gapminder\",\n    x = \"Continents in Gapminder\",\n    y = \"Countries per Continent\",\n    caption = \"Data as of 2007\"\n  )\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/ggplot-customization-1.png){width=672}\n:::\n:::\n\n\n\n\n## Advanced `ggplot2`\n\n## \"But isn't there an easier way?\"\n\nYes, there is!\\\n`ggplot2` is all about the building blocks, and for many common scenarios it's cumbersome to always stack the same components on top of each other.\\\nLuckily there are *tons* of R packages either extending ggplot2 or providing wrappers for common needs.\n\nOne of those wrapper packages is [`ggstatsplot`](https://indrajeetpatil.github.io/ggstatsplot), which you should have installed earlier in the course but which we haven't used yet.\n\nAs the title suggest this package is primarily aimed towards statistical comparisons, but it can also be used for exploratory analyses.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggstatsplot)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nYou can cite this package as:\n     Patil, I. (2021). Visualizations with statistical details: The 'ggstatsplot' approach.\n     Journal of Open Source Software, 6(61), 3167, doi:10.21105/joss.03167\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |>\n  filter(year == 2007) |>\n  ggbetweenstats(\n    x = continent, y = lifeExp,\n    xlab = \"Continent\",\n    ylab = \"Life Expectancy (years)\",\n    title = \"Life Expectancy by Continent (2007)\"\n  )\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-26-1.png){width=672}\n:::\n:::\n\n\n\n\nWe can disable some of the statistical information by using `bf.message = FALSE` and `results.subtitle = FALSE`:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |>\n  filter(year == 2007) |>\n  ggbetweenstats(\n    x = continent, y = lifeExp,\n    xlab = \"Continent\",\n    ylab = \"Life Expectancy (years)\",\n    bf.message = FALSE, \n    results.subtitle = FALSE,\n    title = \"Life Expectancy by Continent (2007)\"\n  )\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n\n\n\nRecreating something like this with `ggplot2` is a bit of a chore, but `ggstatsplot` makes it a lot easier!\nHere's an incomplete attempt of recreating the above plot:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |>\n  filter(year == 2007) |>\n    ggplot(aes(x = continent, y = lifeExp)) +\n    geom_violin() +\n    geom_boxplot(alpha = .1, width = 0.4) +\n    geom_point(\n      aes(fill = continent),\n      shape = 21, size = 3, stroke = 0, alpha = .4,\n      position = position_jitter(width = 0.1)\n    ) +\n    stat_summary(fun = mean, geom = \"point\", shape = 21, size = 3, color = \"black\", fill = \"darkred\") +\n    labs(\n      title = \"Life Expectancy by Continent (2007)\",\n      subtitle = \"Data via Gapminder\",\n      x = \"Continent\",\n      y = \"Life Expectancy (years)\"\n    ) +\n    theme_minimal(base_size = 14) +\n    theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](05-ggplot2_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "05-ggplot2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}